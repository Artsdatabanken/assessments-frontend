@model AlienSpeciesListViewModel;
@using static Assessments.Frontend.Web.Infrastructure.Constants;
@using static Assessments.Frontend.Web.Infrastructure.Helpers;
@using static Assessments.Frontend.Web.Infrastructure.AlienSpecies.FilterHelpers;
@using System.Linq;

@{
    var AllAreas = Areas.AlienSpecies2023Areas;
    var AllCategories = Categories.AlienSpecies2023Categories;
    //var AllCriterias = ViewBag.AllCriterias;
    var AllEstablishmentCategories = EstablishmentCategory.AlienSpecies2023EstablishmentCategory;
    var AllHabitats = Habitat.AlienSpecies2023Habitats;
    var AllProductionSpecies = ProductionSpecies.AlienSpecies2023ProductionSpecies;
    var AllRegions = Regions.AlienSpecies2023Regions;
    var AllSpeciesGroups = SpeciesGroups.AlienSpecies2023SpeciesGroups;
    var AllTaxonRanks = TaxonRank.AlienSpecies2023TaxonRanks;
    var AllWaterRegions = Regions.AlienSpecies2023WaterRegions;

    ControlButtonsViewModel controlButtonsViewModel = new ControlButtonsViewModel
    {
        View = Model.Parameters.View,
        ItemCount = Model.Results.TotalItemCount,
    };
}

@functions{
    void InputTag(string id, string className, string name, string[] elements, string value)
    {
        name = $"Parameters.{name}";
        if (id == "remember_scroll")
        {
            foreach (var item in elements)
                if (item.Contains("scroll_"))
                    value = item.Replace("scroll_", "");
        }
        id = id.Replace(" ", "_");
        <input id="@id" type="checkbox" class="@className" name=@name value="@value" @(elements.Contains(value) ? " checked=checked" : String.Empty) />
    }

    void InputTag(string name, string[] elements, string value)
    {
        InputTag(value, "submitOnclick", name, elements, value);
    }

    void GetSubSpeciesGroupList(Filter.FilterItem parentSpecies, string name)
    {
        <div class="filter_@parentSpecies.Name">
            <ul class="@parentSpecies.Name-filters">
                    @foreach (var species in parentSpecies.SubGroup)
                {
                    <li class="checkbox">
                        <label for="@species.NameShort">
                            @{
                            InputTag(species.NameShort, $"{parentSpecies.Name}_input submitOnclick", name, Model.Parameters.SpeciesGroups, species.NameShort);
                            }
                            <span class="label_text">@species.Name</span>
                        </label>
                    </li>
                }
                </ul>
        </div>
    }

    void MakeCheckBoxLi(string value, string label, string name, string[] model, string labelClassName, string inputClassName)
    {        
        string id = value.Replace(" ", "_");
        <li class="checkbox">
            <label for="@id" class="@labelClassName">
                @{
                    InputTag(value, $"{inputClassName} submitOnclick", name, model, value);
                }
                <span class="label_text">@label</span>
            </label>
        </li>
    }

    void MakeFilterElement(string buttonText, string filterName, string buttonname)
    {
        string action = $"show_{filterName.ToLower()}";
        string id = $"list_header_{filterName.ToLower()}";

        InputTag(action, "collapse_checkbox", "IsCheck", Model.Parameters.IsCheck, filterName);
        <button name="@buttonname" class="list_header" id="@id" onclick="collapse('@action')" type="button">
                    @buttonText
            <span class="filternumber">@GetActiveFilters(filterName, Model.Parameters)</span>
        </button>
    }

    void MakeFilterGroup(string filterName, string modelName, bool isSubGroup, string[] filterModel, Filter.FilterItem[] filterItems, string buttonText, string buttonName, string outerClassName)
    {
        string className = isSubGroup ? $"filter_subgroup filter_{filterName.ToLower()}" : $"filter_{filterName.ToLower()}";

        <li class="filter_group">
            @{
                MakeFilterElement(buttonText, filterName, buttonName);
            }
            <div class=@className>
                <ul>
                    @{
                        string label;
                        string value;
                        string markAllClassName = "mark_all";
                        MakeCheckBoxLi(filterName, "Merk alle", modelName, filterModel, markAllClassName, outerClassName);
                        foreach (var el in filterItems)
                        {
                            value = el.NameShort;
                            label = filterName == nameof(Model.Parameters.Category) ? $"{el.NameShort} - {el.Description}" : el.Name;
                            string extraOuterClassName = $"{outerClassName} {filterName}_input";
                            if (el.SubGroup != null)
                            {
                                MakeFilterGroup(el.NameShort, modelName, true, filterModel, el.SubGroup, el.Name, $"{el.Name}filtre", extraOuterClassName);
                            }
                            else
                            {
                                MakeCheckBoxLi(value, label, modelName, filterModel, string.Empty, extraOuterClassName);
                            }
                        }
                    }
                </ul>
            </div>
        </li>
    }

    void MakeFilterGroup(string filterName, string[] filterModel, Filter.FilterItem[] filterItems, string buttonText, string buttonName)
    {
        MakeFilterGroup(filterName, filterName, false, filterModel, filterItems, buttonText, buttonName, string.Empty);
    }

    void RenderChip(string buttontext, string filterValue)
    {
        <button class="chips generic" onclick="submitClickedElement('@filterValue')" type="submit">
            <span>@buttontext</span>
            <span class="x" >
                <span class="material-icons">close</span>Fjern
            </span>
        </button>
    }

    void MakeFilterChips(string[] filterModel, Filter.FilterItem[] filterItems)
    {
        foreach (var filter in filterModel)
        {
            string buttonText = GetChipText(filter, filterItems);
            if (!string.IsNullOrEmpty(buttonText))
                RenderChip(buttonText, filter);
        }

    }
}

<!--- # of hits in search and their corresponding filter-chips -->
<div class="empty_filters">
    <p class="hit_count_text">
        <span class="searchstring">
            @FormatNumeric(Model.Results.TotalItemCount.ToString()) treff
            @if (GetActiveSelectionCount(Model.Parameters) != 0
|| !string.IsNullOrEmpty(GetActiveSelection(Model.Parameters)))
            {
                <span>
                    @if (!string.IsNullOrEmpty(GetActiveSelection(Model.Parameters)))
                    {
                        string searchstring = " for " + '"' + @GetActiveSelection(Model.Parameters) + '"';
                        <span>@searchstring</span>
                        <button class="button tinybutton tertiary search_related" name="remove_search" value="true">
                            <span class="material-icons">close</span>Fjern søk
                        </button>
                    }
                </span>
                <span class="filterbox">
                    @if (GetActiveSelectionCount(Model.Parameters) > 0)
                    {
                        MakeFilterChips(Model.Parameters.Area, AllAreas);
                        MakeFilterChips(Model.Parameters.Category, AllCategories);
                        MakeFilterChips(Model.Parameters.EstablishmentCategories, AllEstablishmentCategories);
                        MakeFilterChips(Model.Parameters.ProductionSpecies, AllProductionSpecies);
                        MakeFilterChips(Model.Parameters.SpeciesGroups, AllSpeciesGroups);
                        MakeFilterChips(Model.Parameters.TaxonRank, AllTaxonRanks);
                        MakeFilterChips(Model.Parameters.Habitats, AllHabitats);
                        MakeFilterChips(Model.Parameters.Regions, AllRegions);
                        MakeFilterChips(Model.Parameters.WaterRegions, AllWaterRegions);
                        //makeFilterChips("Criterias", Model.Parameters.Criterias, AllCriterias);
                    }

                    @{string buttontext = @GetActiveSelectionCount(Model.Parameters) + " filter"; }
                    @if(GetActiveSelectionCount(Model.Parameters) > 1)
                    {
                        buttontext.Replace("filter", "filtre");
                        <button class="button tinybutton tertiary search_related" name="Parameters.@nameof(Model.Parameters.RemoveFilters)" value="true">
                            <span class="material-icons">close</span>Fjern alle filter
                        </button>
                    }        
                </span>
            }
        </span>
    </p>
</div>

<!-- CONTROL BUTTONS and toggles-->
<div class="controls">
    <div class="list_control_buttons">
        <button class="toggle_filter only_mobile list_actions no_js" id="open_filter" value="open_filters" name="Åpne filter" type="button" onclick="openFilters()">
            @if (GetActiveSelectionCount(Model.Parameters) != 0)
            {
                <span class="filternumber">@GetActiveSelectionCount(Model.Parameters)</span>
            }
            <span class="material-icons">filter_list</span>Filter
        </button>

        @if (Model.Parameters.View != "stat")
        {
            <select asp-for="Parameters.SortBy" id="sort_results" class="sort_by list_actions" onchange="this.form.submit()">
                <option value="@nameof(AlienSpeciesAssessment2023.ScientificName)">Artsnavn</option>
                <option value="@nameof(AlienSpeciesAssessment2023.VernacularName)">Populærnavn</option>
                <option value="@nameof(AlienSpeciesAssessment2023.Category)">Kategori</option>
            </select>
        }
    </div>
    <partial name="/Views/Shared/_ControlButtons.cshtml" model="controlButtonsViewModel" />
</div>

<div class="listwrapper">
    <div class="filtercontainer">
        @{ InputTag("initial_check", "meta_checkbox", "Meta", Model.Parameters.Meta, "Visited");}
        @{ InputTag("remember_scroll", "meta_checkbox", "Meta", Model.Parameters.Meta, "0");}
        <!-- View controls -->
        <div id="filters" class="filteX no_js hide_on_smallscreen">
            <div id="filter_modal_background">
                <div id="filters_scrollable" class="filter_background">
                    <div class="filter_groups">
                        <partial name="/Views/Shared/_FilterHeader.cshtml" />
                        <div class="filter_scroll_area">
                            <ul>
                                @{
                                    MakeFilterGroup(nameof(Model.Parameters.Area), Model.Parameters.Area, AllAreas, SearchAndFilterNames.AssessmentArea, "områdefiltre");
                                    MakeFilterGroup(nameof(Model.Parameters.Category), Model.Parameters.Category, AllCategories, SearchAndFilterNames.Category, "kategorifiltre");
                                    MakeFilterGroup(nameof(Model.Parameters.TaxonRank), Model.Parameters.TaxonRank, AllTaxonRanks, SearchAndFilterNames.TaxonRank, "'taksonomisk nivå'-filtre");
                                    MakeFilterGroup(nameof(Model.Parameters.EstablishmentCategories), Model.Parameters.EstablishmentCategories, AllEstablishmentCategories, SearchAndFilterNames.EstablishmentCategory, "etableringsklassefiltre");
                                    MakeFilterGroup(nameof(Model.Parameters.ProductionSpecies), Model.Parameters.ProductionSpecies, AllProductionSpecies, SearchAndFilterNames.ProductionSpecies, "'produksjonsart'-filtre");
                                    MakeFilterGroup(nameof(Model.Parameters.SpeciesGroups), Model.Parameters.SpeciesGroups, AllSpeciesGroups, SearchAndFilterNames.SpeciesGroup, "artsgruppefiltre");
                                    MakeFilterGroup(nameof(Model.Parameters.Habitats), Model.Parameters.Habitats, AllHabitats, "Hovedhabitat", "hovedhabitatfiltre");
                                    MakeFilterGroup(nameof(Model.Parameters.Regions), Model.Parameters.Regions, AllRegions, "Regioner og havområder", "regionfiltre");
                                    MakeFilterGroup(nameof(Model.Parameters.WaterRegions), Model.Parameters.WaterRegions, AllWaterRegions, "Vannregioner", "vannregionfiltre");
                                    //makeFilterGroup(nameof(Model.Parameters.Criterias), Model.Parameters.Criterias, AllCriterias, @SearchAndFilter.SearchChooseCriteria, "kriteriefiltre");
                                }
                            </ul>
                        </div>
                        <partial name="/Views/Shared/_FilterMobileButtons.cshtml" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <partial name="/Views/AlienSpecies/2023/ListPartials/_View.cshtml" />
</div>
