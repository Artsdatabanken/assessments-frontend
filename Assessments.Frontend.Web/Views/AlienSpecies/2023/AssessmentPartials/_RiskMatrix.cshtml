@model AlienSpeciesDetailViewModel
@using Assessments.Mapping.AlienSpecies.Model.Enums
@*
   Risk Matrix
   Direct copy from 2018 version. 

   Hel linje - 
    > Angir beste anslått plassering i matrisa 
    > bestemmer kategorie     
    ScoreInvasionPotential (x-aksen) 
    ScoreEcologicalEffect (y-aksen)

   Striplede linjer - 
   > angir usikkerheten. 
   > Utgangspunkt i kategoriplasseringsruta
   > Kan bevege seg i to akser:
   - horisontalt (x-aksen) 
   - eller/og vertikalt (y-aksen). 
   - Kan ikke gå på skrå.

   x-aksen: A-C-kriteriene

   Datagrunnlag:
   - AlienSpeciesAssessment2023Criterion Criteria. 
   
   y-aksen:
   
   > den/de av kriteriene D-I som har høyest Value. 
   > Hvis UncertaintyValues.Length > 1 for denne / en av disse
    => UncertaintyValues for den/de relevante kriteriene  => usikkerhet på y-aksen (vertikalt i matrisa).
   > Hvis UncertaintyValues.Length == 1 => ingen usikkerhet på y-aksen.

   __________
Logikken er slik på y-aksen: 
Finn fram til den/de av kriteriene D-I som har høyest Value. 
Hvis UncertaintyValues.Length > 1 for denne / en av disse, 
skal UncertaintyValues OPPOVER for den/de relevante kriteriene 
vises som usikkerhet i matrisa på y-aksen (vertikalt i matrisa). 
Usikkerhet nedover skal kun vises hvis alle kriteriene med høyest 
skår har usikkerhet nedover.

Denne Ovis aries musimon skal f.eks. ikke vise fram noen usikkerhet 
nedover i matrisa :) 
Hvis UncertaintyValues.Length == 1,
så skal det ikke vises fram noe usikkerhet på y-aksen.

> TLDR:; det er flere utslagsgivende kriterier på y-aksen 
og minst en av disse har usikkerhet oppover - så skal det vises. 
[usikkerhet oppover = høyere usikkerhetsverdi enn kriterieverdien]

> hvis det er flere utslagsgivende kriterier på y-aksen og 
alle disse har usikkerhet nedover - så skal det vises



*@

@{
    // Obtain Criteria Letters
    var A = AlienSpeciesAssessment2023CriteriaLetter.A;
    var B = AlienSpeciesAssessment2023CriteriaLetter.B;
    var C = AlienSpeciesAssessment2023CriteriaLetter.C;

    // Calculate category placement on the grid
    int x = Model.Assessment.ScoreInvasionPotential.Value;
    int y = Model.Assessment.ScoreEcologicalEffect.Value;
    var place = x + "" + y;

    // Calculate uncertainty
    var criteria = Model.Assessment.Criteria;
    var determiningCriteriaY = "";
    var highestCriteriaValueY = 0;
    List<int> uncertaintiesY = new List<int>();

    var whichAxis = "";

    foreach (var criterium in criteria)
    {
        var letter = criterium.CriteriaLetter;
        if(letter == A || letter == B || letter == C){
            // X-axis
            whichAxis += "x";
        }else
        {
            // y-axis
            if(criterium.UncertaintyValues.Count > 1 && criterium.Value > 0)
            {
                whichAxis += ">y<";

                if(criterium.Value == highestCriteriaValueY)
                {
                    // Add current instance as they are equal
                    determiningCriteriaY += criterium.CriteriaLetter; // add letter to list of highest rated criteria
                    uncertaintiesY.Concat(criterium.UncertaintyValues); // Adds ALL uncertainty values to one list
                }else if(criterium.Value > highestCriteriaValueY)
                {
                    // Replace old highest instance
                    highestCriteriaValueY = criterium.Value;
                    determiningCriteriaY = "" + criterium.CriteriaLetter;
                    uncertaintiesY = criterium.UncertaintyValues;
                }
            }
            else
            {
                // No uncertainty for this one. skip it.
                whichAxis += "-y-";
            }
        } 
    }

    var yLowerUncertainty = highestCriteriaValueY;
    var yhigherUncertainty = highestCriteriaValueY;

    foreach (var uncertainty in uncertaintiesY)
    {
        if(uncertainty < yLowerUncertainty)
        {
            yLowerUncertainty = uncertainty;
        }
        if(uncertainty > yhigherUncertainty)
        {
            yhigherUncertainty = uncertainty;
        }
    }

    /*
    * y: Alltid vis usikkerhet oppover
    * y: Hvis mer enn en må alle ha usikkerhet ned for at det vises 
    */
}

@functions{
    string className(int current_x, int current_y, int place_x, int place_y,int highestUncertainty_y){

        string name = "" + current_x + current_y;
        string place = "" + place_x + place_y;
        string classN = "inactive";

        if(current_x == place_x)
        {
            // Add uncertainty to the y-axis only for the current column on the x-axis.
            if (highestUncertainty_y >=  current_y)
            {
                classN = "uncertain";
            }
        }

        if(name == place)
        {
            classN = "active";            
        }
        return classN;
    }
}
<h2>Risikomatrisen</h2>

<p>
    En forklaring er bra å ha. @whichAxis
    <br/>

    x: @x <br/> 
    y: @y 
    <br/>
    @determiningCriteriaY = @highestCriteriaValueY <br/>
    @{
        foreach (var uncertainty in uncertaintiesY)
        {
            <b>@uncertainty</b>
        }
        
    }
    <br/>
    @yLowerUncertainty LOWEST - Needs more tinkling. ALL of them must be low which is currently not the case.<br/>
    @yhigherUncertainty HIGHEST
    
</p>
<figure class="risk-level-matrix">
    <table>
        <tbody>
            
            <tr>
                <td rowspan="4" class="legend legend-v"><span>Økologisk effekt</span></td>
                <td class="description"><span>4</span> stor</td>
                <td class="cat-ph @className(1, 4, x, y, yhigherUncertainty )" id="risk-41">14</td>
                <td class="cat-hi @className(2, 4, x, y, yhigherUncertainty )"  id="risk-42">24</td>
                <td class="cat-se @className(3, 4, x, y, yhigherUncertainty )"  id="risk-43">34</td>
                <td class="cat-se @className(4, 4, x, y, yhigherUncertainty )"  id="risk-44">44</td>
            </tr>
            <tr>
                <td class="description"><span>3</span> middels</td>
                <td class="cat-lo @className(1, 3, x, y, yhigherUncertainty )" id="risk-31">13</td>
                <td class="cat-hi @className(2, 3, x, y, yhigherUncertainty )" id="risk-32">23</td>
                <td class="cat-hi @className(3, 3, x, y, yhigherUncertainty )" id="risk-33">33</td>
                <td class="cat-se @className(4, 3, x, y, yhigherUncertainty )" id="risk-34">43</td>
            </tr>
            <tr>
                <td class="description"><span>2</span> liten</td>
                <td class="cat-lo @className(1, 2, x, y, yhigherUncertainty )" id="risk-21">12</td>
                <td class="cat-lo @className(2, 2, x, y, yhigherUncertainty )" id="risk-22">22</td>
                <td class="cat-lo @className(3, 2, x, y, yhigherUncertainty )" id="risk-23">32</td>
                <td class="cat-hi @className(4, 2, x, y, yhigherUncertainty )" id="risk-24">42</td>
            </tr>
            <tr>
                <td class="description"><span>1</span> ingen kjent</td>
                <td class="cat-nk @className(1, 1, x, y, yhigherUncertainty )" id="risk-11">11</td>
                <td class="cat-lo @className(2, 1, x, y, yhigherUncertainty )" id="risk-12">21</td>
                <td class="cat-lo @className(3, 1, x, y, yhigherUncertainty )" id="risk-13">31</td>
                <td class="cat-ph @className(4, 1, x, y, yhigherUncertainty )" id="risk-14">41</td>
            </tr>
            <tr>
                <td class="description"></td>
                <td class="description"></td>
                <td class="description"><span>1</span> lite</td>
                <td class="description"><span>2</span> begrensa</td>
                <td class="description"><span>3</span> moderat</td>
                <td class="description"><span>4</span> stor</td>
            </tr>
        <tr>
            <td class="legend"></td>
            <td></td>
            <td colspan="4" class="legend">Invasjonspotensial</td>
        </tr>
        </tbody>
    </table>
   <!--  <a class="info-link" href="/pages/239659" target="_blank">Forklaring på risikomatrisen</a>-->
</figure>