@model Artsdatabanken.RL2021
@* SEE example by searching species Bombus hyperboreus *@

@{
    Artsdatabanken.RL2021 assessment = Model;
    string ekspertgruppe = char.ToLower(@Model.Ekspertgruppe[0]) + @Model.Ekspertgruppe.Substring(1);

    var kriteriedok = assessment.Kriteriedokumentasjon;
    if (!kriteriedok.Contains("<br/>") && kriteriedok.Length > 500)
    {
        // IN cases with big blocks of text with no line breaks, detect when a sentence ends in
        // parenhesis and create line break. These sentences are often of concluding nature
        // such as references or summarising some content, which is a nice time to take a break.
        kriteriedok = kriteriedok.Replace(").", ").<br/>");
    }


    @if (!string.IsNullOrWhiteSpace(kriteriedok))
    {

        // Remove weird
        kriteriedok = kriteriedok.Replace("<u><br/></u>", "");

        // Turn u and b into headings
        kriteriedok = kriteriedok.Replace("<b>", "<h3>");
        kriteriedok = kriteriedok.Replace("</b>", "</h3>");
        kriteriedok = kriteriedok.Replace("<u>", "<h3>");
        kriteriedok = kriteriedok.Replace("</u>", "</h3>");

        // Fix specific cases it went wrong
        kriteriedok = kriteriedok.Replace("<h3>)</h3>", ")");

        // Remove empty tags
        kriteriedok = kriteriedok.Replace("<b></b>", "");
        kriteriedok = kriteriedok.Replace("<u></u>", "");
        kriteriedok = kriteriedok.Replace("<h3></h3>", "");
        kriteriedok = kriteriedok.Replace("<i> </i>", " ");
                
        // Br into paragraphs
        kriteriedok = kriteriedok.Replace("<br/><br/>", "<br/>");
        kriteriedok = "<p>" + kriteriedok.Replace("<br/>", "</p><p>") + "<p>";

    }
}



@if (!((Model.Kategori == "NA" || Model.Kategori == "NE" || Model.Kategori == "LC") && (Model.Kriteriedokumentasjon == "" || Model.Kriteriedokumentasjon == null)))
{

    <div class="page_section">
        <h2>
            Oppsumering av vurdering
        </h2>
        <span></span>@kriteriedok

        <!-- Kategori Kriteriedokumentasjon -->
        @if (!string.IsNullOrWhiteSpace(assessment.Kriteriedokumentasjon))
        {
            <div class="expert_assesment">

                <div class="quoatedtext">
                    <span class="quotationmark">“</span>
                    <div class="expert_text">@Html.Raw(kriteriedok)</div>
                    <br />
                    -
                    Ekspertkomité for @ekspertgruppe<span class="quotationmark">”</span>
                </div>
            </div>



            <!-- Kategori endring -->
            @if (!string.IsNullOrEmpty(Model.KategoriEndretTil) && Model.UtdøingSterktPåvirket == "Ja")
            {<h3>Kategori-endring</h3>
                <div>Kategori endret til: @assessment.KategoriEndretTil</div>
            }

            <!-- Kategori UtdøingSterktPåvirket -->
            @if (assessment.UtdøingSterktPåvirket == "Ja")
            {
                <h3>Er utdøing Påvirket?</h3>
                @if (assessment.KategoriEndretFra != "" && assessment.KategoriEndretFra != null)
                {
                    <div class="changedCat">Risiko for utdøing er sterkt påvirket av populasjoner i naboland. Kategori er derfor justert fra @assessment.KategoriEndretFra til @assessment.KategoriEndretTil. @Html.Raw(@assessment.ÅrsakTilNedgraderingAvKategori)</div>
                }
                else
                {
                    <div class="changedCat">Risiko for utdøing er sterkt påvirket av populasjoner i naboland. Kategori er derfor justert til @assessment.KategoriEndretTil. @Html.Raw(@assessment.ÅrsakTilNedgraderingAvKategori)</div>
                }

            }

            <!-- Årsak til endring av kategori -->
            @if (!string.IsNullOrWhiteSpace(assessment.ÅrsakTilEndringAvKategori) && assessment.KategoriFraForrigeListe != assessment.Kategori)
            {
                <h3>Årsak til endring av kategori</h3>
                <div class="changedCat">Kategorien er endret fra forrige rødlistevurdering på grunn av @assessment.ÅrsakTilEndringAvKategori.Substring(0, 1).ToLower()@assessment.ÅrsakTilEndringAvKategori.Substring(1).</div>
            }

            @if (Model.Kategori.IndexOf("CR") >= 0 || Model.Kategori.IndexOf("EN") >= 0 || Model.Kategori.IndexOf("VU") >= 0 || Model.Kategori.IndexOf("NT") >= 0)
            {
                <h3>Gjeldende kriterier</h3>
                <p><b>@Model.Kriterier</b></p>
                <p class="fact_box">@ViewBag.glossary["oneliners"]["gjeldendekriterier"]</p>
            }

            <span class="criteria_conclusions">
                <partial name="/Views/Test/partials_2021/Kriterier_2021/_Kriterie_Automatic.cshtml" />
            </span>

        }










        <!-- Generasjonslengde-->
        @if (Model.Generasjonslengde != "" && Model.Generasjonslengde != null)
        {
            <h3>Generasjonstid: @assessment.Generasjonslengde år</h3>
            <p class="fact_box">
                @ViewBag.glossary["generasjonstid"]["description"]
            </p>
        }
    </div><!-- End section -->
}
