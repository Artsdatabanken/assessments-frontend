@model AlienSpeciesDetailViewModel
@using Assessments.Mapping.AlienSpecies.Model.Enums
@*
   Risk Matrix
   Direct copy from 2018 version. 

   Hel linje - 
    > Angir beste anslått plassering i matrisa 
    > bestemmer kategorie     
    ScoreInvasionPotential (x-aksen) 
    ScoreEcologicalEffect (y-aksen)

   Striplede linjer - 
   > angir usikkerheten. 
   > Utgangspunkt i kategoriplasseringsruta
   > Kan bevege seg i to akser:
   - horisontalt (x-aksen) 
   - eller/og vertikalt (y-aksen). 
   - Kan ikke gå på skrå.

   x-aksen: A-C-kriteriene

   Datagrunnlag:
   - AlienSpeciesAssessment2023Criterion Criteria. 
   
   y-aksen:
   
   > den/de av kriteriene D-I som har høyest Value. 
   > Hvis UncertaintyValues.Length > 1 for denne / en av disse
    => UncertaintyValues for den/de relevante kriteriene  => usikkerhet på y-aksen (vertikalt i matrisa).
   > Hvis UncertaintyValues.Length == 1 => ingen usikkerhet på y-aksen.


*@

@{
    // Obtain Criteria Letters
    var A = AlienSpeciesAssessment2023CriteriaLetter.A;
    var B = AlienSpeciesAssessment2023CriteriaLetter.B;
    var C = AlienSpeciesAssessment2023CriteriaLetter.C;

    // Calculate category placement on the grid
    int x = Model.Assessment.ScoreInvasionPotential.Value;
    int y = Model.Assessment.ScoreEcologicalEffect.Value;
    var place = x + "" + y;

    // Calculate uncertainty
    var criteria = Model.Assessment.Criteria;
    var determiningCriteriaY = "";
    var highestCriteriaValueY = 0;
    var yLowerUncertainty = highestCriteriaValueY;
    var yhigherUncertainty = highestCriteriaValueY;
    List<int> uncertaintiesY = new List<int>();

    var whichAxis = "";

    foreach (var criterium in criteria)
    {
        var letter = criterium.CriteriaLetter;
        if(letter == A || letter == B || letter == C){
            // X-axis
            whichAxis += "x";
        }else
        {
            // y-axis
            if(criterium.UncertaintyValues.Count > 1 && criterium.Value > 0)
            {
                whichAxis += ">y<";

                if(criterium.Value == highestCriteriaValueY)
                {
                    // COMPARE And update the previous highest criteria
                    determiningCriteriaY += criterium.CriteriaLetter; // add letter to string of highest rated criteria for testing
                    var newUncertainties = criterium.UncertaintyValues;
                    var newLowerUncertainty = criterium.Value;

                    // obtain top and bottom of range for this criteria
                    foreach (var uncertainty in newUncertainties)
                    {
                        if(uncertainty > yhigherUncertainty)
                        { 
                            // always use the highest directly
                            yhigherUncertainty = uncertainty;
                        }
                        if(uncertainty < newLowerUncertainty)
                        {   
                            // set uncertainty for this criteria only
                            newLowerUncertainty = uncertainty;
                        }
                    }

                    // REQUIREMENT: multiple counting criterias must have 
                    // the same lower uncertainty or be reset back to criteria score.

                    if(newLowerUncertainty != yLowerUncertainty)
                    {
                        yLowerUncertainty = criterium.Value;
                    }

                    uncertaintiesY.Concat(criterium.UncertaintyValues); // Adds ALL uncertainty values to one list


                }else if(criterium.Value > highestCriteriaValueY)
                {
                    // SET/RESET all values to this criterium
                    determiningCriteriaY = "" + criterium.CriteriaLetter;

                    // Start all values at criteria value
                    highestCriteriaValueY = criterium.Value;
                    yhigherUncertainty = criterium.Value;
                    yLowerUncertainty = criterium.Value;       
                    
                    // Obtain top and bottom uncertainties
                    uncertaintiesY = criterium.UncertaintyValues;
                    foreach (var uncertainty in uncertaintiesY)
                    {
                        if(uncertainty < yLowerUncertainty)
                        {
                            yLowerUncertainty = uncertainty;
                        }
                        if(uncertainty > yhigherUncertainty)
                        {
                            yhigherUncertainty = uncertainty;
                        }
                    }                    
                }
            }
            else
            {
                // No uncertainty for this one. skip it.
                whichAxis += "-y-";
            }
        } 
    }

@functions{
    string className(int current_x, int current_y, int place_x, int place_y,int highestUncertainty_y, int lowestUncertainty_y){

        string name = "" + current_x + current_y;
        string place = "" + place_x + place_y;
        string classN = "inactive";

        if(current_x == place_x)
        {
            // Add UPWARDS uncertainty to the y-axis only for the current column on the x-axis.
            if (current_y <= highestUncertainty_y && current_y > place_y)
            {
                // y value smaller than the highest cap
                // higher than the category value
                classN = "uncertain " + highestUncertainty_y + " " +current_y + " " + place_y;               
            }

            // Add DOWNWARDS uncertainty to the y-axis only for the current column on the x-axis.
            if (current_y >= lowestUncertainty_y && current_y < place_y)
            {
                // y value higher than the lowest cap
                // lower than the category value
                classN = "uncertain " + lowestUncertainty_y + " " +current_y + " " + place_y;               
            }
        }

        if(name == place)
        {
            classN = "active";            
        }
        return classN;
    }
}
<h2>Risikomatrisen</h2>

<p>
    En forklaring er bra å ha. @whichAxis
    <br/>

    x: @x <br/> 
    y: @y 
    <br/>
    @determiningCriteriaY = @highestCriteriaValueY <br/>
    @{
        foreach (var uncertainty in uncertaintiesY)
        {
            <b>@uncertainty</b>
        }
        
    }
    <br/>
    @yLowerUncertainty LOWEST <br/>
    @yhigherUncertainty HIGHEST
    
</p>
<figure class="risk-level-matrix">
    <table>
        <tbody>
            
            <tr>
                <td rowspan="4" class="legend legend-v"><span>Økologisk effekt</span></td>
                <td class="description"><span>4</span> stor</td>
                <td class="cat-ph @className(1, 4, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-41">14</td>
                <td class="cat-hi @className(2, 4, x, y, yhigherUncertainty, yLowerUncertainty )"  id="risk-42">24</td>
                <td class="cat-se @className(3, 4, x, y, yhigherUncertainty, yLowerUncertainty )"  id="risk-43">34</td>
                <td class="cat-se @className(4, 4, x, y, yhigherUncertainty, yLowerUncertainty )"  id="risk-44">44</td>
            </tr>
            <tr>
                <td class="description"><span>3</span> middels</td>
                <td class="cat-lo @className(1, 3, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-31">13</td>
                <td class="cat-hi @className(2, 3, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-32">23</td>
                <td class="cat-hi @className(3, 3, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-33">33</td>
                <td class="cat-se @className(4, 3, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-34">43</td>
            </tr>
            <tr>
                <td class="description"><span>2</span> liten</td>
                <td class="cat-lo @className(1, 2, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-21">12</td>
                <td class="cat-lo @className(2, 2, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-22">22</td>
                <td class="cat-lo @className(3, 2, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-23">32</td>
                <td class="cat-hi @className(4, 2, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-24">42</td>
            </tr>
            <tr>
                <td class="description"><span>1</span> ingen kjent</td>
                <td class="cat-nk @className(1, 1, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-11">11</td>
                <td class="cat-lo @className(2, 1, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-12">21</td>
                <td class="cat-lo @className(3, 1, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-13">31</td>
                <td class="cat-ph @className(4, 1, x, y, yhigherUncertainty, yLowerUncertainty )" id="risk-14">41</td>
            </tr>
            <tr>
                <td class="description"></td>
                <td class="description"></td>
                <td class="description"><span>1</span> lite</td>
                <td class="description"><span>2</span> begrensa</td>
                <td class="description"><span>3</span> moderat</td>
                <td class="description"><span>4</span> stor</td>
            </tr>
        <tr>
            <td class="legend"></td>
            <td></td>
            <td colspan="4" class="legend">Invasjonspotensial</td>
        </tr>
        </tbody>
    </table>
   <!--  <a class="info-link" href="/pages/239659" target="_blank">Forklaring på risikomatrisen</a>-->
</figure>